  # Copyright 2020 Google LLC
  #
  # Licensed under the Apache License, Version 2.0 (the "License");
  # you may not use this file except in compliance with the License.
  # You may obtain a copy of the License at
  #
  #     http://www.apache.org/licenses/LICENSE-2.0
  #
  # Unless required by applicable law or agreed to in writing, software
  # distributed under the License is distributed on an "AS IS" BASIS,
  # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  # See the License for the specific language governing permissions and
  # limitations under the License.
  
apiVersion: kms.cnrm.cloud.google.com/v1beta1
kind: KMSCryptoKey
metadata:
    labels:
      key-one: bq-ds-key-project-id # kpt-set: bq-ds-key-${project-id}
    name: bq-ds-key-project-id # kpt-set: bq-ds-key-${project-id}
    namespace: project-namespace # kpt-set: ${project-namespace}
spec:
    keyRingRef:
      name: bq-key-ring-project-id # kpt-set: bq-key-ring-${project-id}
    purpose: ENCRYPT_DECRYPT
    versionTemplate:
      algorithm: GOOGLE_SYMMETRIC_ENCRYPTION 
      protectionLevel: SOFTWARE
---

apiVersion: kms.cnrm.cloud.google.com/v1beta1
kind: KMSCryptoKey
metadata:
    labels:
      key-one: bq-table-key-project-id # kpt-set: bq-table-key-${project-id}
    name: bq-table-key-project-id # kpt-set: bq-table-key-${project-id}
    namespace: project-namespace # kpt-set: ${project-namespace}
spec:
    keyRingRef:
      name: bq-key-ring-project-id # kpt-set: bq-key-ring-${project-id}
    purpose: ENCRYPT_DECRYPT
    versionTemplate:
      algorithm: GOOGLE_SYMMETRIC_ENCRYPTION 
      protectionLevel: SOFTWARE
---
apiVersion: kms.cnrm.cloud.google.com/v1beta1
kind: KMSKeyRing
metadata:
    annotations:
       cnrm.cloud.google.com/blueprint: cnrm/landing-zone/v0.4.0
       cnrm.cloud.google.com/project-id: project-id # kpt-set: ${project-id}
    name: bq-key-ring-project-id # kpt-set: bq-key-ring-${project-id}
    namespace: project-namespace # kpt-set: ${project-namespace}
spec:
    location: data-location # kpt-set: ${data-location}

---
apiVersion: iam.cnrm.cloud.google.com/v1beta1
kind: IAMPartialPolicy
metadata: # kpt-merge: config-control/logging-sa-iam-permissions
  name: dataset-kms-binding-project-id # kpt-set: dataset-kms-binding-${project-id}
  namespace: project-namespace # kpt-set: ${project-namespace}
  annotations:
    cnrm.cloud.google.com/blueprint: cnrm/landing-zone:log-export/v0.4.0
spec:
  resourceRef:
    apiVersion: kms.cnrm.cloud.google.com/v1beta1
    kind: KMSCryptoKey
    name: bq-ds-key-project-id # kpt-set: bq-ds-key-${project-id}
    namespace: project-namespace # kpt-set: ${project-namespace}
  bindings:
    - role: roles/cloudkms.cryptoKeyEncrypterDecrypter
      members:
        - member: serviceAccount:bq-project-number@bigquery-encryption.iam.gserviceaccount.com # kpt-set: serviceAccount:bq-${project-number}@bigquery-encryption.iam.gserviceaccount.com
